<!--Plots sentiment by no show rate, matched up by day of the week. Zoomed out axis with trendline. -->

<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>D3: Movie Bar Chart</title>
        <script type="text/javascript" src="https://d3js.org/d3.v4.js"></script>
        <style type="text/css">          
            body {
              padding: 10px;
            }
            text {
              font: 16px "Arial";
            }

            .title {
              font: 32px "Arial";
            }
            .text {
              font: 16px "Arial";
            } 
            .line {
              stroke: blue;
              fill:none;
              stroke-width: 3;
            }
        </style>
    </head>
    <body>
        <h1 class="title"> 
        Twitter Sentiment
        &amp;
        Hospital Appointment No-Show Rate
        </h1>
        <p class="text">Explore how the positive or negative sentiment of Tweets on various days of the week affect the no-show rate of hospital appointments.</p>
        <script type="text/javascript">

            var decimalFormat = d3.format("0.2f");

            var type = "Positive"
            var word = "hospital appointment"
            var csv = word + "_computed.csv"

            var body = d3.select('body')

            var margin = {top: 50, right: 50, bottom: 50, left: 50};
            var width = 500 - margin.right;
            var height = 500 - margin.top - margin.bottom;

            var yselectData = [ { "text" : "hospital appointment" },
                     { "text" : "hospital" },
                     { "text" : "appointment" },
                   ]

            var xselectData = [ { "text" : "Positive" },
                     { "text" : "Negative" },
                   ]

            // Select Search Term
            var span = body.append('span')
                .attr('class', 'text')
                .text('Select Twitter Search Term')
            var yInput = body.append('select')
                .attr('id','ySelect')
                .on('change',yChange)
              .selectAll('option')
                .data(yselectData)
                .enter()
              .append('option')
                .attr('value', function (d) { return d.text })
                .text(function (d) { return d.text ;})
            body.append('br')

            // Select X-axis Variable
            var span = body.append('span')
              .attr('class', 'text')
              .text('Select Sentiment Analysis Type: ')
            var yInput = body.append('select')
                .attr('id','xSelect')
                .on('change',xChange)
              .selectAll('option')
                .data(xselectData)
                .enter()
              .append('option')
                .attr('value', function (d) { return d.text })
                .text(function (d) { return d.text ;})
            body.append('br')

            var xMin, xMax, yMin, yMax, xScale, xAxis, yScale, yAxis, svg, dot;

            d3.csv(csv, function(dataset) {

              xMin = 0;//d3.min(dataset, function(d) { return d[type + " Average"]; } );
              xMax = 1;//d3.max(dataset, function(d) { return d[type + " Average"]; } );
              yMin = 0;//d3.min(dataset, function(d) { return d["Percent No Show"]; } );
              yMax = 1;//d3.max(dataset, function(d) { return d["Percent No Show"]; } );
              
              //Scale
              xScale = d3.scaleLinear().domain([xMin, xMax]).range([0, width]);
              yScale = d3.scaleLinear().domain([yMin, yMax]).range([ height, 0]);

              xAxis = d3.axisBottom(xScale).ticks(5);
              yAxis = d3.axisLeft(yScale).ticks(5);

              //Frame
              svg = d3.select("body")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

              //title
              svg.append("text")
              .attr('id', 'title')
              .attr("x", width/2)
              .style('text-anchor', 'middle')
              .text(type + " sentiment on the term: " + word)

              //Axis
              svg
              .append("g")
              .attr("transform", "translate(0," + height + ")")
              .attr("id", "xAxis")
              .call(xAxis);

              svg.append('text') // X-axis Label
              .attr('id','xAxisLabel')
              .attr('y',height-20)
              .attr('x',width)
              .attr('dy','.71em')
              .style('text-anchor','end')
              .text("Percent " + type + " Sentiment");

              svg
              .append("g")
              .attr("id", "yAxis")
              .call(yAxis)

              svg.append('text') // y-axis Label
              .attr('id', 'yAxisLabel')
              .attr('transform','rotate(-90)')
              .attr('x',0)
              .attr('y',5)
              .attr('dy','.71em')
              .style('text-anchor','end')
              .text("Percent No Show");

              //Line
             trend = trends(dataset)
             xValues = xVals(trend)

              var trendline = svg.selectAll(".trendline")
              .data([0, 1, 2, 3])
              .enter()
              .append("line")
              .attr("id", "trendline")
              .attr("class", "trendline")
              .attr("x1", function(d) {
               return xScale(xValues["lowerX"]); })
              .attr("y1", function(d) { 
                return yScale(trend["a"]+xValues["lowerX"]*trend["b"]); })
              .attr("x2", function(d) { 
                return xScale(xValues["upperX"]); })
              .attr("y2", function(d) { return yScale(trend["a"]+xValues["upperX"]*trend["b"]); })
              .attr("stroke", "black")
              .attr("stroke-width", 1);

              svg.append("text")
              .attr("id", "rsq")
              .text("r-sq: " + decimalFormat(trend["r"]))
              .attr("class", "text-label")
              .attr("x", function(d) {
                return 420;
              })
              .attr("y", function(d) {return 30 ;});      

              //Dots
              dot = svg.append("g");

              dot.selectAll("g")
              .data(dataset)
              .enter()
              .append("circle")
              .attr("fill", "#003366")
              .attr("opacity", 5)
              .attr("cx", function(d) {
                return xScale(d[type + ' Average']);
              })
              .attr("cy", function(d) {
                return yScale(d['Percent No Show']);
              })
              .attr("r", 5);
            });

            function yChange() {
              var word = this.value // get the new y value
              var csv = word + "_computed.csv"

              d3.csv(csv, function(dataset) {
                d3.select("#title")
                .transition().duration(1000)
                .text(type + " sentiment on the term: " + word)
                   
                //Trendline
              trend = trends(dataset)
              xValues = xVals(trend)

              d3.selectAll("#trendline")
              .transition().duration(1000)
              .attr("x1", function(d) {
               return xScale(xValues["lowerX"]); })
              .attr("y1", function(d) { 
                return yScale(trend["a"]+xValues["lowerX"]*trend["b"]); })
              .attr("x2", function(d) { 
                return xScale(xValues["upperX"]); })
              .attr("y2", function(d) { return yScale(trend["a"]+xValues["upperX"]*trend["b"]); });
              
              d3.selectAll("#rsq")
                .transition().duration(1000)
                .text("r-sq: " + decimalFormat(trend["r"]));
            

             
                d3.selectAll('circle') // move the circles
                .transition().duration(1000)
                .delay(function (d,i) { return i*100})
                .attr("cx", function(d) {
                  for (i in dataset) {
                    if (dataset[i]["Percent No Show"] == d["Percent No Show"]) {
                      return xScale(dataset[i][type + " Average"])
                    }
                  }
                  return xScale(d[type + ' Average']);
                })
              });
            }

            function xChange() {
              type = this.value // get the new x value

              d3.csv(csv, function(dataset) {

                d3.select('#xAxisLabel')
                .transition().duration(1000)
                .text("Percent " + type + " Sentiment");

                d3.select("#title")
                .transition().duration(1000)
                .text(type + " sentiment on the term: " + word)

                //Trendline

                                //Trendline
              trend = trends(dataset)
              xValues = xVals(trend)
              d3.selectAll("#trendline")
              .transition().duration(1000)
              .attr("x1", function(d) {
               return xScale(xValues["lowerX"]); })
              .attr("y1", function(d) { 
                return yScale(trend["a"]+xValues["lowerX"]*trend["b"]); })
              .attr("x2", function(d) { 
                return xScale(xValues["upperX"]); })
              .attr("y2", function(d) { return yScale(trend["a"]+xValues["upperX"]*trend["b"]); });
              
              
              d3.selectAll("#rsq")
                .transition().duration(1000)
                .text("r-sq: " + decimalFormat(trend["r"]));

                    
                d3.selectAll('circle') // move the circles
                .transition().duration(1000)
                .delay(function (d,i) { return i*100})
                .attr("cx", function(d) {
                  for (i in dataset) {
                    if (dataset[i]["Percent No Show"] == d["Percent No Show"]) {
                      return xScale(dataset[i][type + " Average"])
                    }
                  }
                  return xScale(d[type + ' Average']);
                })
              });
            }

            function trends(dataset) {
              sum_x = 0;
              sum_y = 0;
              sum_xy = 0;
              sum_xx = 0;
              sum_yy = 0;
              n = 0;
              
              dataset.map(function(d) {
                x = parseFloat(d[type + " Average"]);
                y = parseFloat(d["Percent No Show"]);
                sum_x += x;
                sum_y += y;
                sum_xy += x*y;
                sum_xx += x*x;
                sum_yy += y*y;
                n += 1;
              });

              b = (n*sum_xy - sum_x*sum_y)/(n*sum_xx - sum_x*sum_x)
              a = (sum_y - b*sum_x) / n
              r = (n*sum_xy-sum_x*sum_y)/Math.sqrt((n*sum_xx-sum_x*sum_x)*(n*sum_yy-sum_y*sum_y))
              return {"a": a, "b": b, "r": r};
            }

            function xVals(trends) { 
            graphMin = 0
            graphMax = .99
            lowerX = (graphMin-trend["a"])/trend["b"]
             upperX = (graphMax-trend["a"])/trend["b"]
             if (lowerX < upperX) { 
               lowerX = Math.max(lowerX, graphMin)
               upperX = Math.min(upperX, graphMax)
             } else {
               lowerX = Math.min(lowerX, graphMax)
               upperX = Math.max(upperX, graphMin)
             }
             return {"lowerX": lowerX, "upperX": upperX}

            }


        </script>
    </body>
</html>
